<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì—ì´ë© ì¼ì¼ë¡œê·¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f5f5f7;
      color: #111;
    }
    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #fff;
    }
    /* ìƒë‹¨ ì•±ë°” */
    .app-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid #ddd;
    }
    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 16px;
      border: none;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
    }
    .app-title {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 700;
      font-size: 1rem;
    }
    .app-title-emoji {
      font-size: 1.1rem;
    }
    .app-title-text {
      font-size: 1rem;
    }

    .content {
      flex: 1;
      padding: 8px 12px 120px; /* ì•„ë˜ìª½ ì—¬ë°±: ê¸°ë¡ì…ë ¥ + ë„¤ë¹„ê²Œì´ì…˜ */
      overflow-y: auto;
    }

    /* ì§„í–‰ë¥  ë°” */
    .progress-card {
      margin-top: 8px;
      padding: 10px;
      border-radius: 12px;
      background: #fafafa;
      border: 1px solid #e0e0e0;
    }
    .progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 0.85rem;
    }
    .progress-label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .progress-bar-wrap {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #e5e5e5;
      overflow: hidden;
    }
    .progress-bar-fill {
      width: 40%; /* TODO: ì‹¤ì œ ë°ì´í„°ì™€ ì—°ë™ */
      height: 100%;
      background: #50c878;
      transition: width 0.2s ease;
    }

    /* ìƒë‹¨ ìš”ì•½ ì¹´ë“œ (ì•½ ë³µìš© / ìˆ˜ë©´ ê´€ë¦¬) */
    .summary-card {
      margin-top: 8px;
      padding: 10px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #dde3ff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    .summary-row {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 0;
      font-size: 0.85rem;
      flex-wrap: wrap;
    }
    .summary-label {
      width: 66px;
      font-weight: 600;
    }
    .summary-slot {
      font-weight: 500;
      min-width: 40px;
    }
    .summary-time-plan {
      font-size: 0.78rem;
      color: #777;
    }
    .summary-time-plan.done {
      text-decoration: line-through;
      color: #bbb;
    }
    .summary-time-actual {
      font-size: 0.85rem;
      color: #d32f2f;
      font-weight: 600;
    }
    .summary-diff {
      font-size: 0.78rem;
      color: #d32f2f;
    }
    .summary-checkbox {
      transform: scale(1.1);
    }
    .btn-next, .btn-prev {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.78rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-next {
      border: none;
      background: #4caf50;
      color: #fff;
      margin-left: auto;
    }
    .btn-prev {
      border: 1px solid #bbb;
      background: #ffffff;
      color: #555;
    }

    /* ì•½&ìˆ˜ë©´ ì•„ì½”ë””ì–¸ */
    details.accordion {
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fafafa;
    }
    details.accordion summary {
      list-style: none;
      padding: 8px 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.9rem;
      font-weight: 600;
    }
    details.accordion[open] summary {
      border-bottom: 1px solid #ddd;
    }
    details.accordion summary::-webkit-details-marker {
      display: none;
    }
    .accordion-body {
      padding: 8px 8px 10px;
    }
    .accordion-arrow {
      font-size: 0.9rem;
    }

    .two-columns {
      display: flex;
      gap: 8px;
    }
    .column-card {
      flex: 1;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      padding: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    .column-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .slot-row {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      padding: 2px 0;
      flex-wrap: wrap;
    }
    .slot-row input[type="checkbox"] {
      flex-shrink: 0;
    }
    .slot-name {
      min-width: 40px;
    }
    .slot-plan {
      font-size: 0.75rem;
      color: #777;
    }
    .slot-plan.done {
      text-decoration: line-through;
      color: #bbb;
    }
    .slot-actual {
      font-size: 0.75rem;
      color: #d32f2f;
    }
    .slot-diff {
      font-size: 0.75rem;
      color: #d32f2f;
    }

    /* ê¸°ë¡ ë³´ê¸° */
    .state-log-list {
      max-height: 160px;
      overflow-y: auto;
      font-size: 0.8rem;
    }
    .state-log-item {
      padding: 4px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .state-log-time {
      font-size: 0.75rem;
      color: #777;
    }

    /* í•˜ë‹¨ ì…ë ¥ ë°” (ë‚´ ìƒíƒœ ê¸°ë¡) */
    .state-input-bar {
      position: sticky;
      bottom: 48px; /* ë„¤ë¹„ê²Œì´ì…˜ ë†’ì´ */
      background: #ffffff;
      border-top: 1px solid #ddd;
      padding: 4px 10px 6px;
      z-index: 6;
    }
    .state-input-title {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .state-input-row {
      display: flex;
      gap: 6px;
      margin-top: 2px;
    }
    .state-input-row input[type="text"] {
      flex: 1;
      padding: 6px;
      font-size: 0.85rem;
    }
    .btn-send {
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 999px;
      border: none;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }

    /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
    .bottom-nav {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      height: 48px;
      border-top: 1px solid #ddd;
      background: #fff;
      display: flex;
      z-index: 5;
    }
    .nav-item {
      flex: 1;
      font-size: 0.7rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #555;
    }
    .nav-item.active {
      color: #1976d2;
      font-weight: 600;
    }

    /* --- ì•½&ìˆ˜ë©´ ìƒì„¸ë³´ê¸° ì „ìš© ìŠ¤íƒ€ì¼ --- */
    .medset-header {
      margin-top: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .medset-header-dot {
      font-size: 1.1rem;
    }
    .medset-tabs {
      margin-top: 8px;
      display: flex;
      border-bottom: 1px solid #ddd;
    }
    .medset-tab {
      flex: 1;
      padding: 8px 0;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      background: #f5f5f5;
      color: #555;
    }
    .medset-tab.active {
      background: #e1e3ff;
      color: #111;
      font-weight: 600;
      border-bottom: 2px solid #5c6bc0;
    }

    .medset-section-title {
      margin-top: 10px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .med-card {
      margin-top: 6px;
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      padding: 10px;
    }
    .med-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .med-card-title {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .med-card-date {
      text-align: center;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .med-card-date span {
      padding: 2px 6px;
      border-radius: 999px;
      background: #f5f5f5;
    }
    .med-row {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
      flex-wrap: wrap;
      font-size: 0.8rem;
    }
    .med-row-label {
      width: 40px;
      font-weight: 600;
    }
    .med-input-text {
      flex: 1;
      min-width: 60px;
      padding: 4px;
      font-size: 0.78rem;
    }
    .med-input-small {
      width: 50px;
      padding: 4px;
      font-size: 0.78rem;
    }
    .med-select {
      padding: 3px;
      font-size: 0.78rem;
    }
    .med-delete-btn {
      margin-left: auto;
      padding: 2px 6px;
      font-size: 0.7rem;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fff0f0;
      color: #d32f2f;
      cursor: pointer;
    }
    .med-footer-row {
      margin-top: 8px;
      text-align: right;
    }
    .btn-primary {
      padding: 6px 12px;
      font-size: 0.8rem;
      border-radius: 999px;
      border: none;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
    }

    .med-delete-list {
      margin-top: 8px;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 10px;
      font-size: 0.78rem;
    }
    .med-delete-list-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .med-calendar-card {
      margin-top: 10px;
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      padding: 10px;
      font-size: 0.8rem;
    }
    .med-calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .med-calendar-header span {
      font-weight: 600;
    }
    .med-calendar-month-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 2px 6px;
    }
    .med-calendar-grid {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin-bottom: 6px;
    }
    .med-calendar-grid th,
    .med-calendar-grid td {
      text-align: center;
      padding: 2px 0;
    }
    .med-calendar-grid th {
      font-weight: 600;
    }
    .med-calendar-grid td span {
      display: inline-block;
      width: 20px;
      height: 20px;
      line-height: 20px;
      border-radius: 50%;
    }
    .med-calendar-grid td span.today {
      background: #ffe082;
      font-weight: 600;
    }
    .med-calendar-grid td span.in-range {
      background: #bbdefb;
    }

    .med-range-buttons {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .med-range-buttons button {
      flex: 1;
      padding: 4px 0;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.78rem;
      background: #f5f5f5;
    }
    .med-range-buttons button.active {
      background: #ffcc80;
      font-weight: 600;
    }
    .med-range-label {
      padding: 4px 6px;
      background: #424242;
      color: #fff;
      border-radius: 6px;
      font-size: 0.75rem;
      text-align: center;
      margin-bottom: 6px;
    }

    @media (min-width: 768px) {
      .app {
        margin-top: 16px;
        margin-bottom: 16px;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.06);
      }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- ìƒë‹¨ ì•±ë°” -->
  <header class="app-bar">
    <button class="icon-btn" title="ì„¤ì • / ë©”ë‰´">
      â˜°
    </button>
    <div class="app-title">
      <span class="app-title-emoji">ğŸ§ </span>
      <span class="app-title-text">A-Lab</span>
    </div>
    <div style="width:32px;height:32px;"></div>
  </header>

  <main class="content">
    <!-- ë·° 1: ì¼ì¼ ë¡œê·¸ (ê¸°ì¡´ í™”ë©´) -->
    <div id="viewDaily">
      <!-- ì§„í–‰ë¥  ì¹´ë“œ -->
      <section class="progress-card">
        <div class="progress-header">
          <div class="progress-label">
            ğŸƒâ€â™€ï¸ <span>ì˜¤ëŠ˜ ì§„í–‰ë¥ </span>
          </div>
          <span class="small" id="progressText">ì•½Â·ìˆ˜ë©´ ê¸°ì¤€ (ì„ì‹œ)</span>
        </div>
        <div class="progress-bar-wrap">
          <div class="progress-bar-fill" id="progressBar"></div>
        </div>
      </section>

      <!-- ìƒë‹¨ ìš”ì•½ ì¹´ë“œ (ì•½ ë³µìš© / ìˆ˜ë©´ ê´€ë¦¬) -->
      <section class="summary-card">
        <!-- ì•½ ë³µìš© -->
        <div class="summary-row" id="summaryMedRow">
          <span class="summary-label">ì•½ ë³µìš©</span>
          <input type="checkbox" id="summaryMedCheck" class="summary-checkbox" />
          <span class="summary-slot" id="summaryMedSlot">-</span>
          <span class="summary-time-plan" id="summaryMedPlan">(--:--)</span>
          <span class="summary-time-actual" id="summaryMedActual"></span>
          <span class="summary-diff" id="summaryMedDiff"></span>
          <button type="button" class="btn-prev" id="summaryMedPrevBtn">ì´ì „</button>
          <button type="button" class="btn-next" id="summaryMedNextBtn">ë‹¤ìŒì—</button>
        </div>
        <!-- ìˆ˜ë©´ ê´€ë¦¬ -->
        <div class="summary-row" id="summarySleepRow">
          <span class="summary-label">ìˆ˜ë©´ ê´€ë¦¬</span>
          <input type="checkbox" id="summarySleepCheck" class="summary-checkbox" />
          <span class="summary-slot" id="summarySleepSlot">-</span>
          <span class="summary-time-plan" id="summarySleepPlan">(--:--)</span>
          <span class="summary-time-actual" id="summarySleepActual"></span>
          <span class="summary-diff" id="summarySleepDiff"></span>
          <button type="button" class="btn-prev" id="summarySleepPrevBtn">ì´ì „</button>
          <button type="button" class="btn-next" id="summarySleepNextBtn">ë‹¤ìŒì—</button>
        </div>
      </section>

      <!-- ì•½&ìˆ˜ë©´ ì•„ì½”ë””ì–¸ -->
      <details class="accordion" id="medSleepAccordion" open>
        <summary>
          <span>ì•½ & ìˆ˜ë©´</span>
          <span class="accordion-arrow" data-for="medSleepAccordion">â–²</span>
        </summary>
        <div class="accordion-body">
          <div class="two-columns">
            <!-- ì•½ ë³µìš© ë¦¬ìŠ¤íŠ¸ -->
            <div class="column-card">
              <div class="column-title">
                <span>ì•½ ë³µìš©</span>
              </div>
              <div id="medSlotsContainer"></div>
            </div>
            <!-- ìˆ˜ë©´ ê´€ë¦¬ ë¦¬ìŠ¤íŠ¸ -->
            <div class="column-card">
              <div class="column-title">
                <span>ìˆ˜ë©´ ê´€ë¦¬</span>
              </div>
              <div id="sleepSlotsContainer"></div>
            </div>
          </div>
        </div>
      </details>

      <!-- ê¸°ë¡ ë³´ê¸° ì•„ì½”ë””ì–¸ -->
      <details class="accordion" id="logAccordion" open>
        <summary>
          <span>ê¸°ë¡ ë³´ê¸°</span>
          <span class="accordion-arrow" data-for="logAccordion">â–²</span>
        </summary>
        <div class="accordion-body">
          <div class="state-log-list" id="stateLogList"></div>
        </div>
      </details>
    </div>

    <!-- ë·° 2: ì•½&ìˆ˜ë©´ ìƒì„¸ë³´ê¸° (ì„¤ì • íƒ­) -->
    <div id="viewMedSettings" style="display:none;">
      <div class="medset-header">
        <span class="medset-header-dot">â—</span>
        <span>ì•½&ìˆ˜ë©´ ìƒì„¸ë³´ê¸°</span>
      </div>

      <div class="medset-tabs">
        <button type="button" class="medset-tab active" data-medtab="med">ì•½</button>
        <button type="button" class="medset-tab" data-medtab="sleep">ìˆ˜ë©´</button>
      </div>

      <!-- ì•½ íƒ­ ë‚´ìš© -->
      <div id="medTabPane">
        <div class="medset-section-title">* ì•½ ì„¤ì •í•˜ê¸°</div>
        <div class="med-card">
          <div class="med-card-header">
            <span class="med-card-title">ì•½ ì„¤ì •í•˜ê¸°</span>
            <button class="icon-btn" style="width:26px;height:26px;font-size:14px;" title="í¸ì§‘">
              âœï¸
            </button>
          </div>
          <div class="med-card-date">
            <span id="medConfigDate">&lt; ì˜¤ëŠ˜ ë‚ ì§œ &gt;</span>
          </div>

          <!-- ê¸°ë³¸ 6ê°œ í•­ëª© -->
          <div id="medRows">
            <!-- ì˜ˆì‹œ í–‰ í…œí”Œë¦¿ì„ JSì—ì„œ ìƒì„± -->
          </div>

          <!-- ì‚­ì œ ëª©ë¡ / ë³µêµ¬ìš© (UIë§Œ ìš°ì„  êµ¬ì„±) -->
          <div class="med-delete-list">
            <div class="med-delete-list-title">ì‚­ì œ ëª©ë¡ (ìŠ¤ì™€ì´í”„ ëŒ€ì‹  ë²„íŠ¼ìœ¼ë¡œ ì„ì‹œ êµ¬í˜„)</div>
            <div id="medDeletedList">ì‚­ì œëœ í•­ëª©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
            <button type="button" class="btn-primary" id="medRestoreBtn" style="margin-top:4px;">ë³µêµ¬í•˜ê¸°</button>
          </div>

          <div class="med-footer-row">
            <button type="button" class="btn-primary">ì €ì¥</button>
          </div>
        </div>

        <!-- ì•½ ë³µìš© ê¸°ê°„ ì„¤ì •ìš© ë‹¬ë ¥ ì¹´ë“œ (UI ì¤‘ì‹¬, ë™ì‘ì€ ê°„ë‹¨ ì²˜ë¦¬) -->
        <div class="med-calendar-card">
          <div class="med-calendar-header">
            <button class="med-calendar-month-btn" id="calPrevMonthBtn">â—€ì›”</button>
            <span id="calMonthLabel">11ì›”</span>
            <button class="med-calendar-month-btn" id="calNextMonthBtn">ì›”â–¶</button>
          </div>
          <table class="med-calendar-grid">
            <thead>
              <tr>
                <th>SUN</th><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th>
              </tr>
            </thead>
            <tbody id="calBody">
              <!-- JSë¡œ ë‚ ì§œ ì±„ì›€ -->
            </tbody>
          </table>

          <div class="med-range-buttons">
            <button type="button" data-range="7" id="btnRange7">1ì£¼ì¼</button>
            <button type="button" data-range="14" id="btnRange14">2ì£¼ì¼</button>
            <button type="button" data-range="30" id="btnRange30">í•œë‹¬</button>
            <button type="button" data-range="custom" id="btnRangeCustom">(+)</button>
          </div>

          <div class="med-range-label" id="rangeLabel">
            ê¸°ê°„ì„ ì„ íƒí•˜ë©´ ì—¬ê¸°ì—<br/>ì˜ˆ: í•œë‹¬ Â· 25/11.20(ëª©) ~ 26.1.20(í™”)
          </div>

          <div style="text-align:right;margin-top:4px;">
            <button type="button" class="btn-primary">ì €ì¥</button>
          </div>
        </div>
      </div>

      <!-- ìˆ˜ë©´ íƒ­ ë‚´ìš© (ì§€ê¸ˆì€ êµ¬ì¡°ë§Œ, ì¶”í›„ ì„¸ë¶€ ë‚´ìš© ì¶”ê°€) -->
      <div id="sleepTabPane" style="display:none;">
        <div class="medset-section-title" style="margin-top:10px;">ìˆ˜ë©´ ì„¤ì • (ì¶”í›„ êµ¬ì²´í™”)</div>
        <div class="med-card">
          <p style="font-size:0.8rem;margin:0;">
            ìˆ˜ë©´ íƒ­ì„ ëˆŒë €ì„ ë•Œ ë³´ì—¬ì¤„ ìƒì„¸ ì„¤ì • ì˜ì—­ì…ë‹ˆë‹¤.<br/>
            ìˆ˜ë©´ ì‹œê°„ëŒ€, ì•Œë¦¼, ìˆ˜ë©´ íŒ¨í„´ ë“±ì„ ì—¬ê¸°ì„œ ì„¤ê³„í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    </div>
  </main>

  <!-- ë‚´ ìƒíƒœ ê¸°ë¡ ì…ë ¥ ë°” (ì¼ì¼ ë¡œê·¸ í™”ë©´ì—ì„œë§Œ ë³´ì´ë„ë¡) -->
  <div class="state-input-bar" id="stateInputBar">
    <div class="state-input-title">ë‚´ ìƒíƒœ ê¸°ë¡</div>
    <div class="state-input-row">
      <input type="text" id="stateInput" placeholder="ì§€ê¸ˆ ìƒíƒœë¥¼ í•œ ì¤„ë¡œ ì ì–´ì£¼ì„¸ìš”." />
      <button type="button" class="btn-send" id="stateSendBtn">ì „ì†¡</button>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <div class="nav-item active" data-tab="state">
      <div>ğŸ˜Š</div>
      <div>ë‚´ ìƒíƒœ</div>
    </div>
    <div class="nav-item" data-tab="todo">
      <div>âœ…</div>
      <div>í• ì¼ ë£¨í‹´</div>
    </div>
    <div class="nav-item" data-tab="camera">
      <div>ğŸ“·</div>
      <div>ì¹´ë©”ë¼</div>
    </div>
    <div class="nav-item" data-tab="medsleep">
      <div>ğŸ’Š</div>
      <div>ì•½&ìˆ˜ë©´</div>
    </div>
    <div class="nav-item" data-tab="stats">
      <div>ğŸ“Š</div>
      <div>í†µê³„ë³´ê¸°</div>
    </div>
  </nav>
</div>

<script>
  /* -------------------------
     1. ì•½ / ìˆ˜ë©´ ìŠ¬ë¡¯ ê¸°ë³¸ ì„¤ì • (ì¼ì¼ë¡œê·¸ í™”ë©´)
  ------------------------- */
  const medSlotsConfig = [
    { id: "med_morning", label: "ì•„ì¹¨",   planTime: "09:00" },
    { id: "med_lunch",   label: "ì ì‹¬",   planTime: "13:00" },
    { id: "med_dinner",  label: "ì €ë…",   planTime: "19:00" },
    { id: "med_night",   label: "ì·¨ì¹¨",   planTime: "23:00" },
    { id: "med_prn",     label: "í•„ìš”ì‹œ", planTime: "--:--" },
    { id: "med_custom",  label: "ì§ì ‘ì…ë ¥", planTime: "--:--" }
  ];

  const sleepSlotsConfig = [
    { id: "sleep_bed",    label: "ëˆ„ì›€",   planTime: "01:00" },
    { id: "sleep_sleep",  label: "ì ë“¦",   planTime: "01:30" },
    { id: "sleep_wake",   label: "ê¸°ìƒ",   planTime: "08:00" },
    { id: "sleep_nap",    label: "ë‚®ì ",   planTime: "15:00" },
    { id: "sleep_custom", label: "ì§ì ‘ì…ë ¥", planTime: "--:--" }
  ];

  let medSlotsState = medSlotsConfig.map(s => ({ ...s, checked: false, actualTime: null }));
  let sleepSlotsState = sleepSlotsConfig.map(s => ({ ...s, checked: false, actualTime: null }));

  function firstUncheckedIndex(arr) {
    const idx = arr.findIndex(s => !s.checked);
    return idx === -1 ? 0 : idx;
  }

  let currentMedIndex = firstUncheckedIndex(medSlotsState);
  let currentSleepIndex = firstUncheckedIndex(sleepSlotsState);

  /* -------------------------
     2. ì‹œê°„ ê´€ë ¨ ìœ í‹¸
  ------------------------- */
  function formatNowTime() {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${hh}:${mm}`;
  }

  function diffTime(plan, actual) {
    if (!plan || plan === "--:--" || !actual) return "";
    const [ph, pm] = plan.split(":").map(Number);
    const [ah, am] = actual.split(":").map(Number);
    const planMin = ph * 60 + pm;
    const actMin = ah * 60 + am;
    let diff = actMin - planMin; // + ëŠ¦ê²Œ, - ì¼ì°
    const sign = diff === 0 ? "Â±" : (diff > 0 ? "+" : "-");
    diff = Math.abs(diff);
    const h = Math.floor(diff / 60);
    const m = diff % 60;
    return `${sign}${h}h${String(m).padStart(2, "0")}m`;
  }

  /* -------------------------
     3. ì•½/ìˆ˜ë©´ ìŠ¬ë¡¯ ë Œë”ë§
  ------------------------- */
  function renderSlotsList() {
    const medContainer = document.getElementById("medSlotsContainer");
    const sleepContainer = document.getElementById("sleepSlotsContainer");
    medContainer.innerHTML = "";
    sleepContainer.innerHTML = "";

    medSlotsState.forEach((slot, index) => {
      const row = document.createElement("div");
      row.className = "slot-row";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = slot.checked;
      cb.dataset.type = "med";
      cb.dataset.index = index;

      const nameSpan = document.createElement("span");
      nameSpan.className = "slot-name";
      nameSpan.textContent = slot.label;

      const planSpan = document.createElement("span");
      planSpan.className = "slot-plan" + (slot.checked ? " done" : "");
      planSpan.textContent = `(${slot.planTime})`;

      const actualSpan = document.createElement("span");
      actualSpan.className = "slot-actual";
      actualSpan.textContent = slot.actualTime ? slot.actualTime : "";

      const diffSpan = document.createElement("span");
      diffSpan.className = "slot-diff";
      diffSpan.textContent = slot.actualTime ? diffTime(slot.planTime, slot.actualTime) : "";

      row.appendChild(cb);
      row.appendChild(nameSpan);
      row.appendChild(planSpan);
      row.appendChild(actualSpan);
      row.appendChild(diffSpan);
      medContainer.appendChild(row);
    });

    sleepSlotsState.forEach((slot, index) => {
      const row = document.createElement("div");
      row.className = "slot-row";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = slot.checked;
      cb.dataset.type = "sleep";
      cb.dataset.index = index;

      const nameSpan = document.createElement("span");
      nameSpan.className = "slot-name";
      nameSpan.textContent = slot.label;

      const planSpan = document.createElement("span");
      planSpan.className = "slot-plan" + (slot.checked ? " done" : "");
      planSpan.textContent = `(${slot.planTime})`;

      const actualSpan = document.createElement("span");
      actualSpan.className = "slot-actual";
      actualSpan.textContent = slot.actualTime ? slot.actualTime : "";

      const diffSpan = document.createElement("span");
      diffSpan.className = "slot-diff";
      diffSpan.textContent = slot.actualTime ? diffTime(slot.planTime, slot.actualTime) : "";

      row.appendChild(cb);
      row.appendChild(nameSpan);
      row.appendChild(planSpan);
      row.appendChild(actualSpan);
      row.appendChild(diffSpan);
      sleepContainer.appendChild(row);
    });
  }

  function updateProgress() {
    const totalSlots = medSlotsState.length + sleepSlotsState.length;
    const doneSlots =
      medSlotsState.filter(s => s.checked).length +
      sleepSlotsState.filter(s => s.checked).length;
    const rate = totalSlots === 0 ? 0 : Math.round((doneSlots / totalSlots) * 100);
    document.getElementById("progressBar").style.width = `${rate}%`;
    document.getElementById("progressText").textContent = `ì˜¤ëŠ˜ ì²´í¬ ì§„í–‰ë¥  ${rate}% (ì„ì‹œ)`;
  }

  function renderSummary() {
    // ì•½ ë³µìš©
    const medSlot = medSlotsState[currentMedIndex];
    document.getElementById("summaryMedSlot").textContent = medSlot.label;
    const mPlanSpan = document.getElementById("summaryMedPlan");
    mPlanSpan.textContent = `(${medSlot.planTime})`;
    mPlanSpan.className = "summary-time-plan" + (medSlot.checked ? " done" : "");
    const mActualSpan = document.getElementById("summaryMedActual");
    mActualSpan.textContent = medSlot.actualTime ? medSlot.actualTime : "";
    const mDiffSpan = document.getElementById("summaryMedDiff");
    mDiffSpan.textContent = medSlot.actualTime ? diffTime(medSlot.planTime, medSlot.actualTime) : "";
    document.getElementById("summaryMedCheck").checked = medSlot.checked;

    // ìˆ˜ë©´ ê´€ë¦¬
    const sleepSlot = sleepSlotsState[currentSleepIndex];
    document.getElementById("summarySleepSlot").textContent = sleepSlot.label;
    const sPlanSpan = document.getElementById("summarySleepPlan");
    sPlanSpan.textContent = `(${sleepSlot.planTime})`;
    sPlanSpan.className = "summary-time-plan" + (sleepSlot.checked ? " done" : "");
    const sActualSpan = document.getElementById("summarySleepActual");
    sActualSpan.textContent = sleepSlot.actualTime ? sleepSlot.actualTime : "";
    const sDiffSpan = document.getElementById("summarySleepDiff");
    sDiffSpan.textContent = sleepSlot.actualTime ? diffTime(sleepSlot.planTime, sleepSlot.actualTime) : "";
    document.getElementById("summarySleepCheck").checked = sleepSlot.checked;

    updateProgress();
    renderSlotsList(); // ë¦¬ìŠ¤íŠ¸ ìª½ë„ í•¨ê»˜ ê°±ì‹ 
  }

  // ì´ˆê¸° ë Œë”
  renderSummary();

  /* -------------------------
     4. ìŠ¬ë¡¯ í† ê¸€ / ì»¤ì„œ ì´ë™
  ------------------------- */

  function handleSlotToggle(type, index, checkedFromUser) {
    const stateArr = type === "med" ? medSlotsState : sleepSlotsState;
    const slot = stateArr[index];

    slot.checked = checkedFromUser;
    slot.actualTime = checkedFromUser ? formatNowTime() : null;

    renderSummary();
  }

  // í•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ ì²´í¬
  document.getElementById("medSlotsContainer").addEventListener("change", (e) => {
    if (e.target.type === "checkbox") {
      const idx = Number(e.target.dataset.index);
      handleSlotToggle("med", idx, e.target.checked);
    }
  });
  document.getElementById("sleepSlotsContainer").addEventListener("change", (e) => {
    if (e.target.type === "checkbox") {
      const idx = Number(e.target.dataset.index);
      handleSlotToggle("sleep", idx, e.target.checked);
    }
  });

  // ìƒë‹¨ ìš”ì•½ ì²´í¬
  document.getElementById("summaryMedCheck").addEventListener("change", (e) => {
    handleSlotToggle("med", currentMedIndex, e.target.checked);
  });
  document.getElementById("summarySleepCheck").addEventListener("change", (e) => {
    handleSlotToggle("sleep", currentSleepIndex, e.target.checked);
  });

  // ì»¤ì„œ ì´ë™: ë‹¤ìŒ / ì´ì „
  function moveNextSlot(type) {
    const stateArr = type === "med" ? medSlotsState : sleepSlotsState;
    if (!stateArr.length) return;
    if (type === "med") {
      currentMedIndex = (currentMedIndex + 1) % stateArr.length;
    } else {
      currentSleepIndex = (currentSleepIndex + 1) % stateArr.length;
    }
    renderSummary();
  }

  function movePrevSlot(type) {
    const stateArr = type === "med" ? medSlotsState : sleepSlotsState;
    if (!stateArr.length) return;
    if (type === "med") {
      currentMedIndex = (currentMedIndex - 1 + stateArr.length) % stateArr.length;
    } else {
      currentSleepIndex = (currentSleepIndex - 1 + stateArr.length) % stateArr.length;
    }
    renderSummary();
  }

  document.getElementById("summaryMedNextBtn").addEventListener("click", () => {
    moveNextSlot("med");
  });
  document.getElementById("summarySleepNextBtn").addEventListener("click", () => {
    moveNextSlot("sleep");
  });
  document.getElementById("summaryMedPrevBtn").addEventListener("click", () => {
    movePrevSlot("med");
  });
  document.getElementById("summarySleepPrevBtn").addEventListener("click", () => {
    movePrevSlot("sleep");
  });

  /* -------------------------
     5. ë‚´ ìƒíƒœ ê¸°ë¡ / ê¸°ë¡ ë³´ê¸°
  ------------------------- */

  const stateInput = document.getElementById("stateInput");
  const stateLogList = document.getElementById("stateLogList");
  const stateSendBtn = document.getElementById("stateSendBtn");

  const stateLogs = []; // { text, timeStr, totalMinutes, diffText }

  function addStateLog(text) {
    const now = new Date();
    const hh = String(now.getHours()).padStart(2, "0");
    const mm = String(now.getMinutes()).padStart(2, "0");
    const timeStr = `${hh}:${mm}`;
    let totalMinutes = now.getHours() * 60 + now.getMinutes();

    let diffText = "ë°©ê¸ˆ ì „";
    if (stateLogs.length > 0) {
      const prev = stateLogs[stateLogs.length - 1];
      let diffMin = totalMinutes - prev.totalMinutes;
      if (diffMin < 0) diffMin += 24 * 60; // ìì • ë„˜ì–´ê°„ ê²½ìš° ë³´ì •

      if (diffMin < 1) {
        diffText = "ë°©ê¸ˆ ì „";
      } else {
        const h = Math.floor(diffMin / 60);
        const m = diffMin % 60;
        if (h === 0) {
          diffText = `${m}ë¶„ ì „`;
        } else if (m === 0) {
          diffText = `${h}ì‹œê°„ ì „`;
        } else {
          diffText = `${h}ì‹œê°„ ${m}ë¶„ ì „`;
        }
      }
    }

    stateLogs.push({ text, timeStr, totalMinutes, diffText });
    renderStateLogs();
  }

  function renderStateLogs() {
    stateLogList.innerHTML = "";
    const logsToShow = [...stateLogs].reverse(); // ìµœì‹ ì´ ìœ„ë¡œ
    logsToShow.forEach((log) => {
      const item = document.createElement("div");
      item.className = "state-log-item";
      item.innerHTML = `
        <div>${log.text}</div>
        <div class="state-log-time">${log.timeStr} Â· ${log.diffText}</div>
      `;
      stateLogList.appendChild(item);
    });
  }

  stateSendBtn.addEventListener("click", () => {
    const text = stateInput.value.trim();
    if (!text) return;
    addStateLog(text);
    stateInput.value = "";
  });

  stateInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      stateSendBtn.click();
    }
  });

  /* -------------------------
     6. ì•„ì½”ë””ì–¸ í™”ì‚´í‘œ(â–¼/â–²) í† ê¸€
  ------------------------- */
  function updateAccordionArrow(detailsEl) {
    const id = detailsEl.id;
    const arrowSpan = document.querySelector(`.accordion-arrow[data-for="${id}"]`);
    if (!arrowSpan) return;
    arrowSpan.textContent = detailsEl.open ? "â–²" : "â–¼";
  }

  const medSleepAccordion = document.getElementById("medSleepAccordion");
  const logAccordion = document.getElementById("logAccordion");

  [medSleepAccordion, logAccordion].forEach(det => {
    updateAccordionArrow(det);
    det.addEventListener("toggle", () => updateAccordionArrow(det));
  });

  /* -------------------------
     7. ì•½&ìˆ˜ë©´ ìƒì„¸ë³´ê¸° - ì•½ í•­ëª© í–‰ ìƒì„± / ì‚­ì œ ëª©ë¡
  ------------------------- */
  const medRowDefaults = [
    "ì•„ì¹¨",
    "ì ì‹¬",
    "ì €ë…",
    "ì·¨ì¹¨ì „",
    "í•„ìš”ì‹œ",
    "ì§ì ‘ì…ë ¥"
  ];

  let medRowsState = medRowDefaults.map(name => ({
    name,
    deleted: false
  }));

  let deletedRows = [];

  function renderMedRows() {
    const container = document.getElementById("medRows");
    container.innerHTML = "";

    medRowsState.forEach((row, index) => {
      if (row.deleted) return;
      const wrap = document.createElement("div");
      wrap.className = "med-row";

      const label = document.createElement("span");
      label.className = "med-row-label";
      label.textContent = row.name + ":";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.className = "med-input-text";
      nameInput.placeholder = "ì•½ì´ë¦„";

      const doseInput = document.createElement("input");
      doseInput.type = "number";
      doseInput.className = "med-input-small";
      doseInput.placeholder = "ìš©ëŸ‰";

      const unitSel = document.createElement("select");
      unitSel.className = "med-select";
      ["mg","ì•Œ","í¬"].forEach(u => {
        const opt = document.createElement("option");
        opt.value = u;
        opt.textContent = u;
        unitSel.appendChild(opt);
      });

      const timeInput = document.createElement("input");
      timeInput.type = "text";
      timeInput.className = "med-input-small";
      timeInput.placeholder = "00:00";

      const apSel = document.createElement("select");
      apSel.className = "med-select";
      ["A.M","P.M"].forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        apSel.appendChild(opt);
      });

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "med-delete-btn";
      delBtn.textContent = "ì‚­ì œ";
      delBtn.onclick = () => {
        medRowsState[index].deleted = true;
        deletedRows.push(row.name);
        renderMedRows();
        renderDeletedRows();
      };

      wrap.appendChild(label);
      wrap.appendChild(nameInput);
      wrap.appendChild(doseInput);
      wrap.appendChild(unitSel);
      wrap.appendChild(timeInput);
      wrap.appendChild(apSel);
      wrap.appendChild(delBtn);

      container.appendChild(wrap);
    });
  }

  function renderDeletedRows() {
    const box = document.getElementById("medDeletedList");
    if (deletedRows.length === 0) {
      box.textContent = "ì‚­ì œëœ í•­ëª©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
      return;
    }
    box.innerHTML = "";
    deletedRows.forEach((name, idx) => {
      const row = document.createElement("div");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = true;
      cb.dataset.index = idx;
      const label = document.createElement("span");
      label.textContent = " " + name;
      row.appendChild(cb);
      row.appendChild(label);
      box.appendChild(row);
    });
  }

  document.getElementById("medRestoreBtn").addEventListener("click", () => {
    const box = document.getElementById("medDeletedList");
    const checks = box.querySelectorAll("input[type='checkbox']");
    const toRestore = [];
    checks.forEach((cb) => {
      if (cb.checked) {
        const idx = Number(cb.dataset.index);
        toRestore.push(deletedRows[idx]);
      }
    });
    medRowsState = medRowsState.map(row => {
      if (toRestore.includes(row.name)) {
        return { ...row, deleted: false };
      }
      return row;
    });
    deletedRows = deletedRows.filter(name => !toRestore.includes(name));
    renderMedRows();
    renderDeletedRows();
  });

  renderMedRows();
  renderDeletedRows();

  /* -------------------------
     8. ì•½ ì„¤ì •í•˜ê¸° ë‚ ì§œ í‘œì‹œ (ì˜¤ëŠ˜ ê¸°ì¤€)
  ------------------------- */
  function formatMedConfigDate(d) {
    const year = d.getFullYear().toString().slice(2); // 25
    const month = d.getMonth() + 1;
    const date = d.getDate();
    const weekdayNames = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
    const wd = weekdayNames[d.getDay()];
    // ì˜ˆ: 25/11.20(ëª©)
    return `${year}/${month}.${date}(${wd})`;
  }

  const today = new Date();
  const medConfigDateSpan = document.getElementById("medConfigDate");
  medConfigDateSpan.textContent = `â€¹ ${formatMedConfigDate(today)} â€º`;

  /* -------------------------
     9. ë‹¬ë ¥ / ê¸°ê°„ ë²„íŠ¼ (ë‹¨ìˆœ ë²„ì „)
  ------------------------- */
  let calCurrent = new Date(today.getFullYear(), today.getMonth(), 1);
  let rangeInfo = { type: null, days: 0 };

  const calMonthLabel = document.getElementById("calMonthLabel");
  const calBody = document.getElementById("calBody");
  const rangeLabel = document.getElementById("rangeLabel");

  function renderCalendar() {
    const year = calCurrent.getFullYear();
    const month = calCurrent.getMonth(); // 0-11
    calMonthLabel.textContent = `${month + 1}ì›”`;

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    calBody.innerHTML = "";
    let row = document.createElement("tr");
    // ë¹ˆì¹¸
    for (let i = 0; i < firstDay; i++) {
      row.appendChild(document.createElement("td"));
    }
    for (let date = 1; date <= lastDate; date++) {
      const td = document.createElement("td");
      const span = document.createElement("span");
      span.textContent = date;
      const isToday =
        year === today.getFullYear() &&
        month === today.getMonth() &&
        date === today.getDate();
      if (isToday) span.classList.add("today");
      td.appendChild(span);
      row.appendChild(td);
      if ((firstDay + date) % 7 === 0 || date === lastDate) {
        calBody.appendChild(row);
        row = document.createElement("tr");
      }
    }
  }

  renderCalendar();

  document.getElementById("calPrevMonthBtn").addEventListener("click", () => {
    calCurrent.setMonth(calCurrent.getMonth() - 1);
    renderCalendar();
  });
  document.getElementById("calNextMonthBtn").addEventListener("click", () => {
    calCurrent.setMonth(calCurrent.getMonth() + 1);
    renderCalendar();
  });

  function setRange(days, label) {
    rangeInfo.type = label;
    rangeInfo.days = days;
    const start = new Date(today);
    const end = new Date(today);
    end.setDate(end.getDate() + days);
    const startStr = formatMedConfigDate(start);
    const endStr = formatMedConfigDate(end);
    rangeLabel.textContent = `${label} Â· ${startStr} ~ ${endStr}`;
    document.querySelectorAll(".med-range-buttons button").forEach(b => b.classList.remove("active"));
    if (days === 7) document.getElementById("btnRange7").classList.add("active");
    if (days === 14) document.getElementById("btnRange14").classList.add("active");
    if (days === 30) document.getElementById("btnRange30").classList.add("active");
  }

  document.getElementById("btnRange7").addEventListener("click", () => setRange(7, "1ì£¼ì¼"));
  document.getElementById("btnRange14").addEventListener("click", () => setRange(14, "2ì£¼ì¼"));
  document.getElementById("btnRange30").addEventListener("click", () => setRange(30, "í•œë‹¬"));
  document.getElementById("btnRangeCustom").addEventListener("click", () => {
    const daysStr = prompt("ë©°ì¹  ë’¤ê¹Œì§€ ì„¤ì •í• ê¹Œìš”? (ì˜ˆ: 45)");
    const days = Number(daysStr);
    if (!Number.isNaN(days) && days > 0) {
      setRange(days, `ë§ì¶¤ ${days}ì¼`);
    }
  });

  /* -------------------------
     10. ì•½/ìˆ˜ë©´ ìƒì„¸ë³´ê¸° íƒ­ ì „í™˜ (ì•½ / ìˆ˜ë©´)
  ------------------------- */
  const medTabPane = document.getElementById("medTabPane");
  const sleepTabPane = document.getElementById("sleepTabPane");
  document.querySelectorAll(".medset-tab").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".medset-tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const t = btn.dataset.medtab;
      if (t === "med") {
        medTabPane.style.display = "";
        sleepTabPane.style.display = "none";
      } else {
        medTabPane.style.display = "none";
        sleepTabPane.style.display = "";
      }
    });
  });

  /* -------------------------
     11. ë·° ì „í™˜ (ì¼ì¼ë¡œê·¸ â†” ì•½&ìˆ˜ë©´ ìƒì„¸ë³´ê¸°)
  ------------------------- */
  const viewDaily = document.getElementById("viewDaily");
  const viewMedSettings = document.getElementById("viewMedSettings");
  const stateInputBar = document.getElementById("stateInputBar");

  function showDailyView() {
    viewDaily.style.display = "";
    viewMedSettings.style.display = "none";
    stateInputBar.style.display = "";
  }

  function showMedSettingsView() {
    viewDaily.style.display = "none";
    viewMedSettings.style.display = "";
    stateInputBar.style.display = "none";
  }

  /* -------------------------
     12. í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë™ì‘
  ------------------------- */
  document.querySelectorAll(".nav-item").forEach(item => {
    item.addEventListener("click", () => {
      document.querySelectorAll(".nav-item").forEach(i => i.classList.remove("active"));
      item.classList.add("active");
      const tab = item.dataset.tab;

      if (tab === "medsleep") {
        showMedSettingsView();
        return;
      }

      // ë‚˜ë¨¸ì§€ëŠ” ì¼ë‹¨ ì¼ì¼ë¡œê·¸ í™”ë©´ì— ë¨¸ë¬¼ê²Œ
      showDailyView();
      if (tab !== "state") {
        alert(`"${item.innerText.trim()}" í™”ë©´ì€ ì¶”í›„ ì—°ê²° ì˜ˆì •ì…ë‹ˆë‹¤.`);
      }
    });
  });
</script>
</body>
</html>
